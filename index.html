<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JAYS CHAT - Profile</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
        integrity="sha512-p+1PT0mWubjvWcP3Wn0lKFoFvyVz5Gv98kN0I4uUlnE1G8xqh6b6fY6H/+pX9Ik0llL+gN7mX4jrlxK9Qq6D7A==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Reset and base styles */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: #f0f2f5;
    }
    /* Header */
    header {
      background: #1877f2;
      color: #fff;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    header .header-buttons {
      display: flex;
      gap: 0.5rem;
    }
    header button, header a {
      background: #fff;
      color: #1877f2;
      border: none;
      padding: 0.5rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      text-decoration: none;
    }
    header button:hover, header a:hover {
      background: #f0f0f0;
    }
    /* Profile Card */
    .profile-wrapper {
      max-width: 900px;
      margin: 2rem auto;
      background: #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    /* Cover Photo Section */
    .cover-photo-container {
      position: relative;
      height: 300px;
      background: #ccc;
      background-size: cover;
      background-position: center;
    }
    .cover-photo-button {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 10;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      background-color: rgba(0, 0, 0, 0.7);
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .cover-photo-button:hover {
      background-color: rgba(0, 0, 0, 0.85);
    }
    /* Profile Picture Section */
    .profile-picture-container {
      position: relative;
      width: 160px;
      height: 160px;
      border: 5px solid #fff;
      border-radius: 50%;
      overflow: hidden;
      margin: -80px auto 10px;
      background: #ddd;
    }
    .profile-picture-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-pic-button {
      position: absolute;
      bottom: 5px;
      right: 5px;
      z-index: 10;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      background-color: rgba(0, 0, 0, 0.7);
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .profile-pic-button:hover {
      background-color: rgba(0, 0, 0, 0.85);
    }
    /* Profile Details Section */
    .profile-details {
      padding: 1.5rem;
      text-align: center;
    }
    .profile-details h2 {
      margin: 0.5rem 0;
      font-size: 2rem;
      color: #1c1e21;
    }
    .profile-details p {
      color: #606770;
      margin: 0.5rem 0;
      font-size: 1rem;
    }
    .profile-form {
      margin-top: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-width: 400px;
      margin: 1.5rem auto 0;
    }
    .profile-form input[type="text"],
    .profile-form input[type="url"],
    .profile-form textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ccd0d5;
      border-radius: 4px;
      font-size: 1rem;
    }
    .profile-form textarea {
      resize: vertical;
      min-height: 80px;
    }
    .profile-form button {
      padding: 0.75rem;
      background: #1877f2;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .profile-form button:hover {
      background: #155bc0;
    }
    .notification {
      text-align: center;
      margin-top: 1rem;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <!-- Header Section with Sign Out and Messaging Icon -->
  <header>
    <h1>Jay's Chat</h1>
    <div class="header-buttons">
      <a href="message.html" title="Messages"><i class="fa-solid fa-message"></i></a>
      <button id="signOutBtn">Sign Out</button>
    </div>
  </header>

  <!-- Profile Card -->
  <div class="profile-wrapper">
    <!-- Cover Photo Section -->
    <div class="cover-photo-container" id="cover-photo" style="background-image: url('https://via.placeholder.com/900x300');">
      <!-- Hidden cover photo input -->
      <input type="file" id="cover-photo-input" accept="image/*" style="display: none;">
      <!-- Button with camera icon -->
      <button class="cover-photo-button" id="cover-photo-button">
        <i class="fa-solid fa-camera"></i>
      </button>
    </div>
    <!-- Profile Picture Section -->
    <div class="profile-picture-container" id="profile-picture">
      <img src="https://via.placeholder.com/160" alt="Profile Picture" id="profile-pic-img">
      <!-- Hidden profile picture input -->
      <input type="file" id="profile-pic-input" accept="image/*" style="display: none;">
      <!-- Button with camera icon -->
      <button class="profile-pic-button" id="profile-pic-button">
        <i class="fa-solid fa-camera"></i>
      </button>
    </div>
    <!-- Profile Details Section -->
    <div class="profile-details">
      <h2 id="display-name">Your Name</h2>
      <p id="bio-display">Your bio goes here...</p>
      <!-- Form for non-image details (editable only once) -->
      <form id="profile-form" class="profile-form">
        <input type="text" id="username" placeholder="Username" />
        <input type="text" id="location" placeholder="Location" />
        <input type="url" id="website" placeholder="Website URL" />
        <textarea id="bio" placeholder="Update your bio..."></textarea>
        <button type="submit">Save Profile</button>
      </form>
      <div class="notification" id="notification"></div>
    </div>
  </div>

  <!-- Firebase SDKs and App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    // Your Firebase configuration â€“ replace with your own values
    const firebaseConfig = {
      apiKey: "AIzaSyBtJ6eEaapIjzSM9hS69Du9S3oCVYBe1Ac",
      authDomain: "jay-chat-91d02.firebaseapp.com",
      databaseURL: "https://jay-chat-91d02-default-rtdb.firebaseio.com",
      projectId: "jay-chat-91d02",
      storageBucket: "jay-chat-91d02.firebasestorage.app",
      messagingSenderId: "627949387755",
      appId: "1:627949387755:web:ff63a69b2a0bf9533163ae",
      measurementId: "G-2X9DG6HV7D"
    };

    // Initialize Firebase
    const appFirebase = initializeApp(firebaseConfig);
    const analytics = getAnalytics(appFirebase);
    const auth = getAuth(appFirebase);
    const db = getFirestore(appFirebase);
    const storage = getStorage(appFirebase);

    // Get UI elements
    const coverPhotoContainer = document.getElementById("cover-photo");
    const coverPhotoInput = document.getElementById("cover-photo-input");
    const coverPhotoButton = document.getElementById("cover-photo-button");

    const profilePicImg = document.getElementById("profile-pic-img");
    const profilePicInput = document.getElementById("profile-pic-input");
    const profilePicButton = document.getElementById("profile-pic-button");

    const displayNameEl = document.getElementById("display-name");
    const bioDisplayEl = document.getElementById("bio-display");
    const profileForm = document.getElementById("profile-form");
    const usernameField = document.getElementById("username");
    const locationField = document.getElementById("location");
    const websiteField = document.getElementById("website");
    const bioField = document.getElementById("bio");
    const notificationEl = document.getElementById("notification");
    const signOutBtn = document.getElementById("signOutBtn");

    let currentUser = null;
    let detailsLocked = false; // Non-picture details can be updated only once

    // Utility: Upload image to Firebase Storage and return its URL
    async function uploadImage(file, path) {
      const storageRef = ref(storage, path);
      const snapshot = await uploadBytes(storageRef, file);
      return await getDownloadURL(snapshot.ref);
    }

    // Load profile data from Firestore
    async function loadProfile(uid) {
      try {
        const docRef = doc(db, "profiles", uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          if (data.coverPhotoUrl) {
            coverPhotoContainer.style.backgroundImage = `url('${data.coverPhotoUrl}')`;
          }
          if (data.profilePicUrl) {
            profilePicImg.src = data.profilePicUrl;
          }
          displayNameEl.textContent = data.displayName || "Your Name";
          bioDisplayEl.textContent = data.bio || "Your bio goes here...";
          usernameField.value = data.username || "";
          locationField.value = data.location || "";
          websiteField.value = data.website || "";
          bioField.value = data.bio || "";
          if (data.detailsLocked) {
            detailsLocked = true;
            usernameField.disabled = true;
            locationField.disabled = true;
            websiteField.disabled = true;
            bioField.disabled = true;
          }
        }
      } catch (error) {
        console.error("Error loading profile:", error);
        notificationEl.textContent = "Failed to load profile.";
      }
    }

    // Handle profile form submission (non-picture details update only once)
    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      notificationEl.textContent = "";
      try {
        const profileData = { updatedAt: new Date() };
        if (!detailsLocked) {
          if (usernameField.value || locationField.value || websiteField.value || bioField.value) {
            const confirmUpdate = confirm("You can update these details only once. Once saved, they cannot be changed. Proceed?");
            if (!confirmUpdate) {
              notificationEl.textContent = "Update cancelled.";
              return;
            }
            profileData.username = usernameField.value;
            profileData.location = locationField.value;
            profileData.website = websiteField.value;
            profileData.bio = bioField.value;
            profileData.detailsLocked = true;
            detailsLocked = true;
            usernameField.disabled = true;
            locationField.disabled = true;
            websiteField.disabled = true;
            bioField.disabled = true;
            if (currentUser && usernameField.value) {
              await updateProfile(currentUser, { displayName: usernameField.value });
              displayNameEl.textContent = usernameField.value;
            }
          }
        }
        await setDoc(doc(db, "profiles", currentUser.uid), profileData, { merge: true });
        notificationEl.textContent = "Profile updated successfully!";
      } catch (error) {
        console.error("Error updating profile:", error);
        notificationEl.textContent = "Error updating profile.";
      }
    });

    // Trigger hidden file input when cover photo button is clicked
    coverPhotoButton.addEventListener("click", () => {
      coverPhotoInput.click();
    });
    // Trigger hidden file input when profile picture button is clicked
    profilePicButton.addEventListener("click", () => {
      profilePicInput.click();
    });

    // Handle cover photo change
    coverPhotoInput.addEventListener("change", async () => {
      const file = coverPhotoInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          coverPhotoContainer.style.backgroundImage = `url('${e.target.result}')`;
        };
        reader.readAsDataURL(file);
        if (currentUser) {
          try {
            const url = await uploadImage(file, `coverPhotos/${currentUser.uid}`);
            await setDoc(doc(db, "profiles", currentUser.uid), { coverPhotoUrl: url }, { merge: true });
          } catch (error) {
            notificationEl.textContent = "Failed to update cover photo.";
          }
        }
      }
    });

    // Handle profile picture change
    profilePicInput.addEventListener("change", async () => {
      const file = profilePicInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          profilePicImg.src = e.target.result;
        };
        reader.readAsDataURL(file);
        if (currentUser) {
          try {
            const url = await uploadImage(file, `profilePictures/${currentUser.uid}`);
            await setDoc(doc(db, "profiles", currentUser.uid), { profilePicUrl: url }, { merge: true });
          } catch (error) {
            notificationEl.textContent = "Failed to update profile picture.";
          }
        }
      }
    });

    // Sign out event handler
    signOutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "https://ceecodes001.github.io/Signup/";
      } catch (error) {
        console.error("Sign out error:", error);
        notificationEl.textContent = "Error signing out.";
      }
    });

    // Check auth state; if not signed in, redirect to index.html
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        if (user.displayName) {
          displayNameEl.textContent = user.displayName;
        }
        loadProfile(user.uid);
      } else {
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>